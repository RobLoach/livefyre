<?php
// $Id$


/**
 * Implementation of hook_menu
 */

function livefyre_menu(){
  return array(
      'admin/settings/livefyre' => array(
        'title' => 'Livefyre',
        'description' => t('Configure livefyre comments'),
        'access arguments' => array('administer livefyre comments'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('livefyre_admin_settings'),
        'file' => 'livefyre.admin.inc',
        ),
      );
}

/**
 * Implementation of hook_nodeapi
 */

function livefyre_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
  switch ($op) {
    case 'view':
      $lf_node_types = variable_get('livefyre_node_types', array());
      $lf_disabled = variable_get('livefyre_disabled', TRUE);
      $lf_account = variable_get('livefyre_acct', '');
      if ($lf_disabled || empty($lf_account)) {
        return;
      }
      
      $show_block = count(array_keys($lf_node_types, $node->type))
                 && (!$teaser && $page && isset($node->body))
                 && (variable_get('livefyre_location', 'content_area') == 'content_area');

      if ($show_block) {
        $post_path = variable_get('livefyre_path_prefix', '').'node/'.$node->nid;
        // if in test mode, change the post_path to something different so test comments don't show up in production
        if (variable_get('livefyre_testmode', FALSE)) {
          $post_path .= '/test';
        }
        $node->content['livefyre'] = array(
          '#value' => theme('livefyre_comments', $lf_account, $post_path),
          '#weight' => variable_get('livefyre_weight', 50),
          );
      }
      break;
    default:
      break;
  }
}

/**
 * Implementation of hook_perm
 */

function livefyre_perm() {
  return array('administer livefyre comments');
}


/**
 * Implementation of hook_block
 */

function livefyre_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      return array(
          'livefyre_comments' => array(
            'info'  => t('Livefyre Comments'),
            'cache' => BLOCK_NO_CACHE),
          );
      break;
    case 'view':
      switch ($delta) {
        case 'livefyre_comments':
          $lf_disabled = variable_get('livefyre_disabled', TRUE);
          $lf_location = variable_get('livefyre_location', 'content_area');
          if (!$lf_disabled && $lf_location == 'block') {
            //$node = menu_get_item();
            //echo '<pre>' . print_r($node, TRUE) . '</pre>';
            //$nid = $node['page_arguments'][0]->nid;
            //$lf_account = variable_get('livefyre_acct', '');
            // $lf_domain = variable_get('domain_root', $_SERVER['HTTP_HOST']);
            // $fisher_lf_domain =  variable_get('fisher_lf_domain', 'fisher-0.fyre.co');
            // $custom_css = variable_get('livefyre_custom_css', '');
            // $custom_js =  variable_get('livefyre_custom_js', '');
            // $livefyre_js =  variable_get('livefyre_js', '');
             $script_snippet =  variable_get('script_snippet', '');





            return array(
                //'content' => theme('livefyre_comments', $lf_account, $nid, $lf_domain, $fisher_lf_domain, $custom_css, $custom_js, $livefyre_js, $script_snippet),
                'content' => theme('livefyre_comments', $script_snippet),
                );
          }
          break;
        default:
          break;
      }
      break;
    default:
      break;
  }
}


/**
 * Implementation of hook_theme
 */

function livefyre_theme() {
  return array(
      'livefyre_comments' => array(
        'arguments' => array(
          'account' => NULL,
          'nid' => NULL,
          'lf_domain' => NULL,
          'fisher_lf_domain' => NULL,
          'custom_css' => NULL,
          'custom_js' => NULL,
          'livefyre_js' => NULL,
          'script_snippet' => NULL,
          ),
        )
      );
}

//function theme_livefyre_comments($account, $nid, $lf_domain, $fisher_lf_domain, $custom_css, $custom_js, $livefyre_js, $script_snippet){
//  return "
//  <link rel='stylesheet' href='$custom_css'>
//  <div id='comments'><div id='livefyre'></div></div>
//<script>
//document.domain = '$lf_domain';
//var login_domain = 'account.$lf_domain',
//lf_domain = '$fisher_lf_domain';
//lf_site_id =  '$account';
//lf_article_id = '$nid';
//$script_snippet;
//
//</script>
//<script src='$livefyre_js'></script>
//<script src='$custom_js'></script>";
//
//}

function theme_livefyre_comments($script_snippet){
  return "
$script_snippet
";



}


